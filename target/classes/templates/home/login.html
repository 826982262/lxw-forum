<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>登录</title>

    <link th:href="@{css/common.css}" type="text/css" rel="stylesheet">
    <link th:href="@{css/themify-icons/style.css}" type="text/css" rel="stylesheet">
    <script th:src="@{js/cryptoJS/core.js}" language="javascript" type="text/javascript"></script>
    <script th:src="@{js/cryptoJS/sha256.js}" language="javascript" type="text/javascript"></script>
    <script language="javascript" th:src="@{js/tool.js}" type="text/javascript"></script>
    <script language="javascript" th:src="@{js/ajax.js}" type="text/javascript"></script>
    <script language="javascript" th:src="@{js/json2.js}" type="text/javascript"></script>
    <link rel="stylesheet" th:href="@{/plugins/bootstrap/css/bootstrap.min.css}">
    <script type="text/javascript" th:src="@{js/jquery/jquery.min.js}" language="javascript"></script>
    <script type="text/javascript" th:src="@{/plugins/bootstrap/js/bootstrap.js}" language="javascript"></script>
<!--    <script th:src="@{https://cdn.bootcdn.net/ajax/libs/sweetalert/2.1.2/sweetalert.min.js}"></script>-->
    <script th:src="@{js/sweetalert.min.js}" type="text/javascript" language="javascript"></script>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css}">
</head>
<body>
<div th:replace="/home/index ::index-head"></div>
<!--<#&#45;&#45; 引入页头 &ndash;&gt;-->
<!--<@include action="${newPublic_2}"/>-->
<div class="skeleton">
    <div class="main wrap backgroundModule" >
        <div class="loginModule" >
            <div class="tabs-nav">
                <div>
                    <div id="local_tab" class="tabs-tab">
                        <a href="javascript:void(0)" class="active">账号密码登录</a>
                    </div>
                    <div id="mobile_tab" class="tabs-tab">
                        <a href="javascript:void(0)">手机号登录</a>
                    </div>
                </div>
            </div>
            <div class="box">
                <div class="form">
                    <!-- 令牌标记 -->
<!--                    <input type="hidden" id="token" name="token" value="${token}">-->
                    <div class="form-field">
                        <!-- form-field-container form-field-error -->
                        <div id="account_field_error" class="form-field-container">
                            <div class="form-field-text" >
                                <div class="form-field-input-container">
                                    <input id="account" maxLength="40" class="form-field-text-input" type="text" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <!-- <label class="mi-floating-label form-field-active ">账号</label>-->
                                    <label class="form-field-label">账号</label>
                                </div>
                            </div>

                            <div id="account_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>
                    <div class="form-field" >
                        <div id="mobile_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="mobile" maxLength="11" class="form-field-text-input" type="text" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">手机号</label>
                                </div>
                            </div>
                            <div id="mobile_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>
                    <div class="form-field" >
                        <div id="password_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="password" maxLength="20" class="form-field-text-input" type="password" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">密码</label>
                                </div>
                            </div>
                            <div id="password_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>
<!--                    <#if formCaptcha.showCaptcha?c == 'false'>style='display: none;'</#if>-->
                    <div id="captchaValue_field" class="form-field" >
                <div id="captchaValue_field_error" class="form-field-container">
                    <div class="form-field-text">
                        <div class="form-field-input-container">
                            <input type="hidden" id="captchaKey" name="captchaKey" value="${formCaptcha.captchaKey}">
                            <input id="captchaValue" class="form-field-text-input" type="text" maxlength="4" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                            <label class="form-field-label">验证码</label>
                        </div>
                        <div class="form-field-image-container">
                            <img id="captcha" src=""  onclick="replaceCaptcha()" tabindex="4" />

                        </div>
                        <div class="form-field-button-container" style="background: #fff;">
                            <button type="button" class="btn btn-link" tabindex="-1" onClick="replaceCaptcha();">换一幅</button>
                        </div>
                    </div>
                    <div id="captchaValue_prompt_error" class="form-field-prompt-error"></div>
                </div>
            </div>
        </div>
        <div id="token_prompt_error" style="color: red;"></div>
<!--                <div id="token_prompt_error" style="color: red;">${(error['token'])!}</div>-->
        <div class="otherInfo">
            <a href="findPassWord/step1" tabindex="8">找回密码？</a>

        </div>
        <div class="loginButton">
            <a href="javascript:void(0);" onClick="javascript:ajaxSubmit()" tabindex="6">登&nbsp;录</a>
        </div>

<!--        <#&#45;&#45; 引入第三方登录模块 &ndash;&gt;-->
<!--        <@include action="${systemRelated_thirdPartyLogin_1}"/>-->
    </div>
</div>
<div class="push"><!-- 将页脚固定在页面底部 --></div>
</div>
</div>
<div th:replace="/home/index :: foot"></div>
<!--<#&#45;&#45; 引入页脚 &ndash;&gt;-->
<!--<@include action="${newPublic_3}"/>-->
<script language="javascript" type="text/javascript">
    $(".form-field").find(".form-field-input-container").bind("mousedown",function(e) {
        $(this).find(".form-field-text-input").focus();

        if($(this).find(".form-field-label").hasClass("form-field-active")){
            return;

        }
        $(this).find(".form-field-label").addClass("form-field-active");
    });

    $(document).mousedown(function (e) {
        var target = $(e.target);
        if (target.closest(".form-field-input-container").length == 0) {
            $(".form-field-input-container").each(function(){
                if($(this).find(".form-field-label").hasClass("form-field-active")){
                    if($(this).find('input[type="text"]').val() == "" || $(this).find('input[type="password"]').val() == ""){
                        $(this).find(".form-field-label").removeClass("form-field-active");
                    }

                }
            });
        }
    });

    //监听Tab键
    $(document).on('keyup',function (e) {
        if(e.keyCode == 9){
            var input = $(this).find('input:focus');
            if (input.length) {
                if(!input.parent().parent().find(".form-field-label").hasClass("form-field-active")){
                    input.parent().parent().find(".form-field-label").addClass("form-field-active");
                }
            }
        }
    });
    //解决提交按钮的click和blur事件冲突
    $(document).ready(function(){
        $("input[type='button']").mousedown(function(e){
            e.preventDefault();
        });
        $("a[href='javascript:void(0);']").mousedown(function(e){
            e.preventDefault();
        });

    });
</script>


<script language="javascript" type="text/javascript">
    //选择账号类型
    $(document).ready(function(){
        //选择
        $(".tabs-nav").find(".tabs-tab").each(function(){
            if($(this).find("a").hasClass("active")){
                selectAccountType($(this).attr("id"));
            }

            $(this).bind("click",function(e) {
                $(".tabs-nav").find(".tabs-tab").each(function(){
                    $(this).find("a").removeClass("active");
                });
                $(this).find("a").addClass("active");
                selectAccountType($(this).attr("id"));
            });
        });
    });

    function selectAccountType(id){
        if(id == "local_tab"){//本地账号密码用户
            $("#account_field_error").parent().show();
            $("#mobile_field_error").parent().hide();
            $("#smsCode_field_error").parent().hide();
        }
        if(id == "mobile_tab"){//手机用户
            $("#account_field_error").parent().hide();
            $("#mobile_field_error").parent().show();
            $("#smsCode_field_error").parent().show();
        }
    }


    //回车键登录
    $(document).keyup(function(event){
        if(event.keyCode ==13){
            ajaxSubmit();
        }
    });

    //点击输入框提示
    function inputBoxClickTip(obj){


    }
    //离开输入框提示
    function inputBoxOutTip(obj){
        verification(obj.id);
    }
    //验证参数
    function verification(field){
        $("#"+field+"_prompt_error").hide();
        $("#"+field+"_field_error").removeClass("form-field-error");

        if(field == "account"){//账号
            var account = $("#"+field).val().trim();
            if(account == ""){
                $("#"+field+"_prompt_error").html("账号不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(account) < 3){
                $("#"+field+"_prompt_error").html("账号长度不能小于3位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(account) > 20){
                $("#"+field+"_prompt_error").html("账号长度不能大于20位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            var pattern =  /^\w+$/;
            if(!pattern.test(account)){
                $("#"+field+"_prompt_error").html("账号只能输入由数字、26个英文字母或者下划线组成");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
        }
        if(field == "mobile"){//手机号
            var mobile = $("#"+field).val().trim();
            if(mobile == ""){
                $("#"+field+"_prompt_error").html("手机号不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(mobile) < 11){
                $("#"+field+"_prompt_error").html("手机号不正确");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }

        }

        if(field == "password"){//密码
            var password = $("#"+field).val().trim();
            if(password == ""){
                $("#"+field+"_prompt_error").html("密码不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(password) < 6){
                $("#"+field+"_prompt_error").html("密码长度不能小于6位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(password) > 20){
                $("#"+field+"_prompt_error").html("密码长度不能大于20位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
        }

        if(field == "captchaValue"){//验证码
            if(!$("#captchaValue_field").is(":hidden")){//如果验证码框显示
                // var captchaKey = $("#captchaKey").val().trim();
                var captchaValue = $("#"+field).val().trim();
                if(captchaValue == ""){
                    $("#"+field+"_prompt_error").html("验证码不能为空");
                    $("#"+field+"_prompt_error").show();
                    $("#"+field+"_field_error").addClass("form-field-error");
                    return false;
                }

                get_request(function(value){
                    if(value == "false"){
                        $("#"+field+"_prompt_error").html("验证码错误");
                        $("#"+field+"_prompt_error").show();
                        $("#"+field+"_field_error").addClass("form-field-error");
                    }
                },
                    "captchaVerification?"+"&captchaValue="+captchaValue+"&timestamp=" + new Date().getTime(), true);

            }
        }
    }


    //加载验证码
    function getcode(){
        var url = "/create_check_code";
        $("#captcha").attr("src",url);

        var url = '/getcode?_timer='+new Date().getTime();

        $.get(
            url,function(res){
                $("#captcha").attr('src','data:image.png;base64,'+res.data)
            }
        )
    }



    //进入页面执行
    window.onload = function () {
        getcode()
    }
    //更换验证码
    function replaceCaptcha(){
        getcode();
        // var captchaKey = document.getElementById("captchaKey").value;
        // document.getElementById("captcha").src = "captcha/"+captchaKey+".jpg?" + Math.random();
    }

    //组装参数
    function getParameter(){
        var parameter = "";


        //令牌标记
        // var token = $("#token").val();
        // parameter += "&token="+token;

        // //验证码Key
        // parameter += "&captchaKey="+encodeURIComponent($("#captchaKey").val());

        //验证码值
        parameter += "&captchaValue="+encodeURIComponent($("#captchaValue").val());
        //url跳转参数
        var jumpUri = getUrlParam("jumpUri");
        if(jumpUri != null){
            parameter += "&jumpUri="+encodeURIComponent(jumpUri);
        }
        //用户类型
        if($("#local_tab").find("a").hasClass("active")){
            parameter += "&type=10";
            //账号
            parameter += "&account="+encodeURIComponent($("#account").val().trim());
        }
        if($("#mobile_tab").find("a").hasClass("active")){
            parameter += "&type=20";
            //手机号
            parameter += "&mobile="+encodeURIComponent($("#mobile").val().trim());
        }

        //密码
        var password = $("#password").val().trim();
        if(password != ""){
            parameter += "&password="+ password;
            // parameter += "&password="+ CryptoJS.SHA256(password);
        }



        //删除第一个&号,防止因为多了&号而出现警告: Parameters: Invalid chunk ignored.信息
        if(parameter.indexOf("&") == 0){
            parameter = parameter.substring(1,parameter.length);
        }
        return parameter;
    }

    //ajax提交
    function ajaxSubmit(){
        if(allVerification() == false){
            return;
        }

        var parameter = getParameter();
        var DataDeal = {
            //
            formToJson: function (data) {
                data=data.replace(/&/g,"\",\"");
                data=data.replace(/=/g,"\":\"");
                data="{\""+data+"\"}";
                return data;
            },
        };

        parameter = DataDeal.formToJson(parameter)
        // alert(parameter)
        json_post_ruquest(function(res){
            if(res != ""){
                    if(res.success==true){
                        if (res.jumpUri != null){
                        window.location.href=res.jumpUri;}
                        else {
                            window.location.href="/index";
                        }
                    }else if(res.success==false) {
                        swal({
                            title: res.message,
                            icon: "error",
                        });
                        getcode();
                    }

            }
        },
            "/forum/login?&timestamp=" + new Date().getTime(), true,parameter);
    }

    //验证全部参数
    function allVerification(){
        var isVerification = true;

        //用户类型
        if($("#local_tab").find("a").hasClass("active")){
            if(verification("uname") == false){
                isVerification = false;
            }
        }
        if($("#mobile_tab").find("a").hasClass("active")){
            if(verification("mobile") == false){
                isVerification = false;
            }
        }



        if(verification("password") == false){
            isVerification = false;
        }
        return isVerification;
    }
</script>
</body>
</html>
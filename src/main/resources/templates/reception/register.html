<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">

    <title>注册</title>
    <link th:href="@{/css/common.css}" type="text/css" rel="stylesheet">
    <link th:href="@{/css/themify-icons/style.css}" type="text/css" rel="stylesheet">
    <script th:src="@{/js/cryptoJS/core.js}" language="javascript" type="text/javascript"></script>
    <script th:src="@{/js/cryptoJS/sha256.js}" language="javascript" type="text/javascript"></script>
    <script language="javascript" th:src="@{/js/tool.js}" type="text/javascript"></script>
    <script language="javascript" th:src="@{/js/ajax.js}" type="text/javascript"></script>
    <script language="javascript" th:src="@{/js/json2.js}" type="text/javascript"></script>
    <script type="text/javascript" th:src="@{/js/jquery/jquery.min.js}" language="javascript"></script>
    <link th:href="@{/js/layer/skin/default/layer.css}"  type="text/css" rel="stylesheet"/>
    <script type="text/javascript" th:src="@{/js/layer/layer.js}" language="javascript"></script>
    <link rel="stylesheet" th:href="@{/plugins/bootstrap/css/bootstrap.min.css}">
    <script type="text/javascript" th:src="@{/plugins/bootstrap/js/bootstrap.js}" language="javascript"></script>
    <script th:src="@{js/sweetalert.min.js}" type="text/javascript" language="javascript"></script>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css}">
</head>
<body>
<!--引入页头-->

<div th:replace="/reception/index ::index-head"></div>


<div class="skeleton">
    <div class="main wrap backgroundModule">

        <div class="registerModule">

<!--                        <a href="javascript:void(0)" class="active">注册</a>-->
                <div class="center-block" style="text-align: center;">
<!--                    <h2 style="font-size: 100%">注册</h2>-->
                    <p class="h3">注  册</p>
            </div>


            <div class="box">
                <div class="form">

                    <div class="form-field">
                        <!-- form-field-container form-field-error -->
                        <div id="account_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="account" maxlength="40" class="form-field-text-input" type="text" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <!-- <label class="mi-floating-label form-field-active ">账号</label>-->
                                    <label class="form-field-label">账号</label>
                                </div>
                            </div>

                            <div id="account_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>

                    <div class="form-field">
                        <!-- form-field-container form-field-error -->
                        <div id="uname_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="uname" maxlength="40" class="form-field-text-input" type="text" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <!-- <label class="mi-floating-label form-field-active ">账号</label>-->
                                    <label class="form-field-label">昵称</label>
                                </div>
                            </div>

                            <div id="uname_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>

                    <div class="form-field">
                        <div id="password_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="password" maxlength="20" class="form-field-text-input" type="password" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">密码</label>
                                </div>
                            </div>
                            <div id="password_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>
                    <div class="form-field">
                        <div id="confirmPassword_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="confirmPassword" maxlength="20" class="form-field-text-input" type="password" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">确认密码</label>
                                </div>
                            </div>
                            <div id="confirmPassword_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>



                    <div class="form-field">
                        <div id="email_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input id="email" maxlength="30" class="form-field-text-input" type="text" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">邮箱</label>
                                </div>
                            </div>
                            <div id="email_prompt_error" class="form-field-prompt-error"></div>
                            <div class="form-field-help">没有可以不填写</div>
                        </div>
                    </div>

                    <!-- 用户自定义注册功能项 -->



                    <div id="captchaValue_field" class="form-field">
                        <div id="captchaValue_field_error" class="form-field-container">
                            <div class="form-field-text">
                                <div class="form-field-input-container">
                                    <input type="hidden" id="captchaKey" name="captchaKey" value="22a69c4086214e5b955d00b9b2abddb7">
                                    <input id="captchaValue" class="form-field-text-input" type="text" maxlength="4" value="" onfocus="inputBoxClickTip(this);" onblur="inputBoxOutTip(this);">
                                    <label class="form-field-label">验证码</label>
                                </div>
                                <div class="form-field-image-container">
                                    <img id="captcha" src="" onclick="replaceCaptcha();" tabindex="4">

                                </div>
                                <div class="form-field-button-container" style="background: #fff;">
                                    <button type="button" class="btn btn-link" tabindex="-1" onclick="replaceCaptcha();">换一幅</button>
                                </div>
                            </div>
                            <div id="captchaValue_prompt_error" class="form-field-prompt-error"></div>
                        </div>
                    </div>
                </div>
                <div id="token_prompt_error" style="color: red;"></div>
                <div id="type_prompt_error" style="color: red;"></div>
                <div id="register_prompt_error" style="color: red;"></div>


                <div class="loginButton">
                    <a href="javascript:void(0);" onclick="javascript:ajaxSubmit()" tabindex="6">注&nbsp;册</a>
                </div>

            </div>


        </div>

    </div>
</div>


<script language="javascript" type="text/javascript">
    $(".form-field").find(".form-field-input-container").bind("mousedown",function(e) {
        $(this).find(".form-field-text-input").focus();

        if($(this).find(".form-field-label").hasClass("form-field-active")){
            return;

        }
        $(this).find(".form-field-label").addClass("form-field-active");
    });

    $(document).mousedown(function (e) {
        var target = $(e.target);
        if (target.closest(".form-field-input-container").length == 0) {
            $(".form-field-input-container").each(function(){
                if($(this).find(".form-field-label").hasClass("form-field-active")){
                    if($(this).find('input[type="text"]').val() == "" || $(this).find('input[type="password"]').val() == ""){
                        $(this).find(".form-field-label").removeClass("form-field-active");
                    }

                }
            });
        }
    });
    //文本框含有默认值时字段名称缩小
    $(document).ready(function(){
        $(".form-field-input-container").each(function(){
            if(!$(this).find(".form-field-label").hasClass("form-field-active")){
                if(($(this).find('input[type="text"]').val() != undefined && $(this).find('input[type="text"]').val() != '')
                    || $(this).find('input[type="password"]').val() != undefined && $(this).find('input[type="password"]').val() != ''){
                    $(this).find(".form-field-label").addClass("form-field-active");
                }

            }
        });
    });


    //监听Tab键
    $(document).on('keyup',function (e) {
        if(e.keyCode == 9){
            var input = $(this).find('input:focus');
            if (input.length) {
                if(!input.parent().parent().find(".form-field-label").hasClass("form-field-active")){
                    input.parent().parent().find(".form-field-label").addClass("form-field-active");
                }
            }
        }
    });
    //解决提交按钮的click和blur事件冲突
    $(document).ready(function(){
        $("input[type='button']").mousedown(function(e){
            e.preventDefault();
        });
        $("a[href='javascript:void(0);']").mousedown(function(e){
            e.preventDefault();
        });

    });
</script>

<script language="javascript" type="text/javascript">

    //点击输入框提示
    function inputBoxClickTip(obj){
    }
    //离开输入框提示
    function inputBoxOutTip(obj){
        verification(obj.id);
    }

    //验证参数
    function verification(field){
        $("#"+field+"_prompt_error").hide();
        $("#"+field+"_field_error").removeClass("form-field-error");

        if(field == "account"){//账号
            var account = $("#"+field).val().trim();
            if(account == ""){
                $("#"+field+"_prompt_error").html("账号不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(account) < 3){
                $("#"+field+"_prompt_error").html("账号长度不能小于3位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(account) > 20){
                $("#"+field+"_prompt_error").html("账号长度不能大于20位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            var pattern =  /^\w+$/;
            if(!pattern.test(account)){
                $("#"+field+"_prompt_error").html("账号只能输入由数字、26个英文字母或者下划线组成");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }

            get_request(function(value){
                if(value == "true"){
                    $("#"+field+"_prompt_error").html("该账号已存在");
                    $("#"+field+"_prompt_error").show();
                    $("#"+field+"_field_error").addClass("form-field-error");
                }
            },
                "forum/exitAccount?account="+account+"&timestamp=" + new Date().getTime(), true);
        }

        if(field == "uname"){//昵称
            var uname = $("#"+field).val().trim();
            if(uname == ""){
                $("#"+field+"_prompt_error").html("昵称不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(uname) < 3){
                $("#"+field+"_prompt_error").html("昵称长度不能小于3位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(uname) > 20){
                $("#"+field+"_prompt_error").html("昵称长度不能大于20位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }

        }

        if(field == "password"){//密码
            var password = $("#"+field).val().trim();
            if(password == ""){
                $("#"+field+"_prompt_error").html("密码不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(password) < 6){
                $("#"+field+"_prompt_error").html("密码长度不能小于6位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
            if(getStringLeng(password) > 20){
                $("#"+field+"_prompt_error").html("密码长度不能大于20位");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
        }
        if(field == "confirmPassword"){//确认密码
            var confirmPassword = $("#"+field).val().trim();
            if(confirmPassword == ""){
                $("#"+field+"_prompt_error").html("确认密码不能为空");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }

            var password = $("#password").val().trim();
            if(confirmPassword != password){
                $("#"+field+"_prompt_error").html("两次密码不相等");
                $("#"+field+"_prompt_error").show();
                $("#"+field+"_field_error").addClass("form-field-error");
                return false;
            }
        }


        if(field == "email"){//邮箱
            var email = $("#"+field).val().trim();
            if(email != ""){
                if(getStringLeng(email) > 60){
                    $("#"+field+"_prompt_error").html("邮箱地址不能超过60个字符");
                    $("#"+field+"_prompt_error").show();
                    $("#"+field+"_field_error").addClass("form-field-error");
                    return false;
                }
                var pattern =  /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
                if(!pattern.test(email)) {
                    $("#"+field+"_prompt_error").html("邮箱格式错误");
                    $("#"+field+"_prompt_error").show();
                    $("#"+field+"_field_error").addClass("form-field-error");
                    return false;
                }

            }
        }



        if(field == "captchaValue"){//验证码
            if(!$("#captchaValue_field").is(":hidden")){//如果验证码框显示
                var captchaValue = $("#"+field).val().trim();
                if(captchaValue == ""){
                    $("#"+field+"_prompt_error").html("验证码不能为空");
                    $("#"+field+"_prompt_error").show();
                    $("#"+field+"_field_error").addClass("form-field-error");
                    return false;
                }

                get_request(function(value){
                    if(value == "false"){
                        $("#"+field+"_prompt_error").html("验证码错误");
                        $("#"+field+"_prompt_error").show();
                        $("#"+field+"_field_error").addClass("form-field-error");
                    }
                },
                    "captchaVerification?"+"&captchaValue="+captchaValue+"&timestamp=" + new Date().getTime(), true);

            }
        }
    }

    //加载验证码
    function getcode(){
        var url = 'getcode?_timer='+new Date().getTime();
        $.get(
            url,function(res){
                $("#captcha").attr('src','data:image.png;base64,'+res.data)
            }
        )
    }



    //进入页面执行
    window.onload = function () {
        getcode()
    }

    //更换验证码
    function replaceCaptcha(){
        getcode()
    }


    //组装参数
    function getParameter(){
        var parameter = "";

        // //url跳转参数
        // var jumpUrl = getUrlParam("jumpUrl");
        // if(jumpUrl != null){
        //     parameter += "&jumpUrl="+encodeURIComponent(jumpUrl);
        // }
        // //令牌标记
        // var token = $("#token").val();
        // parameter += "&token="+token;

        // //验证码Key
        // parameter += "&captchaKey="+encodeURIComponent($("#captchaKey").val());

        //验证码值
        parameter += "&captchaValue="+encodeURIComponent($("#captchaValue").val());

            //账号
            parameter += "&account="+encodeURIComponent($("#account").val().trim());

        //    昵称
        parameter += "&uname="+encodeURIComponent($("#uname").val().trim());
        //密码
        var password = $("#password").val().trim();
        if(password != ""){
            parameter += "&password="+ password;
        }


        //邮箱
        var email = $("#email").val().trim();
        if(email != ""){
            parameter += "&email="+encodeURIComponent(email);
        }


        //删除第一个&号,防止因为多了&号而出现警告: Parameters: Invalid chunk ignored.信息
        if(parameter.indexOf("&") == 0){
            parameter = parameter.substring(1,parameter.length);
        }
        return parameter;
    }

    //ajax提交
    function ajaxSubmit(){

        if(allVerification() == false){
            //需引入layer
            layer.msg('请填好资料再提交', {
                    time: 3000 //3秒关闭（如果不配置，默认是3秒）
                },function(){//关闭后的操作

                }
            );
            return;
        }

        var parameter = getParameter();
        if(parameter.indexOf("&") == 0){
            parameter = parameter.substring(1,parameter.length);
        }

        var DataDeal = {
            //
            formToJson: function (data) {
                data=data.replace(/&/g,"\",\"");
                data=data.replace(/=/g,"\":\"");
                data="{\""+data+"\"}";
                return data;
            },
        };
        parameter = DataDeal.formToJson(parameter)

        json_post_ruquest(function (res) {
            if(res.success==true){
                swal({
                    title: res.message,
                    text: "是否跳转登录页？",
                    icon: "success",
                    button: true,
                    dangerModel: true,
                }).then((flag)=>{
                    if(flag){
                        window.location.href='/login';
                    }
                })
            }else if(res.success==false) {
                swal({
                    title: res.message,
                    icon: "error",
                });
                getcode();
            }
        },
            "forum/register?&timestamp=" + new Date().getTime(), true,parameter);

    }


    //验证全部参数
    function allVerification(){
        var isVerification = true;

        if($("#local_tab").find("a").hasClass("active")){
            if(verification("account") == false){
                isVerification = false;
            }
            if(verification("password") == false){
                isVerification = false;
            }
            if(verification("uname") == false){
                isVerification = false;
            }
            if(verification("confirmPassword") == false){
                isVerification = false;
            }

            if(verification("captchaValue") == false){
                isVerification = false;
            }
        }


        return isVerification;
    }


</script>


<div th:replace="/reception/index :: foot"></div>
</body></html>